<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Filter for beginners</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- p5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.0.0/addons/p5.sound.min.js"></script>
    <!-- ml5 -->
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <!-- got this from: https://learn.ml5js.org -->
    <link rel="stylesheet" href="https://use.typekit.net/nnr1bhn.css">
    <link rel="stylesheet" href="https://use.typekit.net/nnr1bhn.css">
    <style>
        body{
           background: #000;

        }
        video{
            display:none;
            /* hide the video element, but still need it to capture the video */
        }
        canvas{
            margin-left: auto;
            margin-right: auto;
            display: block;
            border-radius: 10px;
        }
        button{
            margin-left: auto;
            margin-right: auto;
            display: block;
            background-color:aquamarine;
            font-family: "sofia-pro", sans-serif;
            font-weight: 700;
            border:none;
            padding-left:40px;
            padding-right:40px;
            padding-top:10px;
            padding-bottom:10px;
            border-radius: 10px;
            margin-top: 20px;
        }
        button:hover{
            background-color: #EF865A;
            color: white;
        }
        h1{
            text-align: center;
            color: white;
            font-family: "futura-pt-bold", sans-serif;
            font-weight: 700;
            font-style: normal;
            letter-spacing:1px;
        }
        p{
            text-align: center;
            color: #EF865A;
            font-family: "sofia-pro", sans-serif;
            font-weight: 400;
            font-style: normal;
            letter-spacing:1px;
        }
        starsButton{
            background-color: #653fe1;
            color: white;
        }
    </style>
</head>
    <body>
        <div>
        <h1>Welcome to our XD Photobooth!</h1>
        <p>Say cheeeeseeeee</p>
        </div>
        <div>
    </body>
    <script>
        //preview bool true false alvorens downloaden
        let video;
        let button;

        let poseNet;
        let pose;
        let skeleton;

        let applyFilter = 'none'; // Variable to track if the "stars" filter should be applied or not
        let starsButton, noFilterButton, mutsButton, mustacheButton; // Variables to store the buttons

        let hatImage;
        let snorImage;

        let capturedImage = null;
        let saveButton;
        let cancelButton;

        let capturing = true;

        function preload() {
            hatImage = loadImage('muts.png');
            snorImage = loadImage('snor.png');
        }

        function setup() {
            let canvas = createCanvas(500, 370);
            background(51);

            // Create the buttons
            starsButton = createButton('Stars');
            starsButton.mousePressed(applyStarsFilter); // Call the applyStarsFilter function when the button is clicked
            starsButton.style('background-color', '#653fe1');

            noFilterButton = createButton('No Filter');
            noFilterButton.mousePressed(applyNoFilter); // Call the applyNoFilter function when the button is clicked
            noFilterButton.style('background-color', '#653fe1');

            mutsButton = createButton('Red hat');
            mutsButton.mousePressed(applyMutsFilter); // Call the applyMutsFilter function when the button is clicked
            mutsButton.style('background-color', '#653fe1');

            mustacheButton = createButton('mustache');
            mustacheButton.mousePressed(applyMustacheFilter); // Call the applyMustacheFilter function when the button is clicked
            mustacheButton.style('background-color', '#653fe1');


            starsButton.position(100, 400);
            noFilterButton.position(starsButton.width + 120, 400);
            mutsButton.position(100, 450);
            mustacheButton.position(mutsButton.width + 120, 450);


            video = createCapture(VIDEO); //access live webcam
            video.size(500, 370); 

            button = createButton('snap this!'); //create a button called "snap"
            button.mousePressed(takesnap); //when the button is pressed, call the function called "takesnap" 

            poseNet = ml5.poseNet(video, modelLoaded);
            poseNet.on('pose', gotPoses);

            //save button
            saveButton = createButton('Save');
            saveButton.mousePressed(saveImage);
            saveButton.hide(); //hide the button until someone clicks snap

            // Create the Cancel button
            cancelButton = createButton('Cancel');
            cancelButton.mousePressed(cancelSave);
            cancelButton.hide();

            //position save and cancel button
            //Create the container div element
            buttonsContainer = createDiv();
            buttonsContainer.style('display', 'flex');
            buttonsContainer.style('justify-content', 'center');
            buttonsContainer.style('margin-top', '10px');
            buttonsContainer.style('margin-bottom', '10px');

            saveButton.style('margin-right', '10px'); // Adjust the margin as per your preference
            cancelButton.style('margin-left', '10px'); // Adjust the margin as per your preference


            // Add the Save and Cancel buttons to the container
            buttonsContainer.child(saveButton);
            buttonsContainer.child(cancelButton);

        }

        function takesnap() {
            capturedImage = get();
            image(capturedImage, 0, 0);
            saveButton.show();
            cancelButton.show();
        }

        function saveImage() {
            save(capturedImage, 'myCanvas', 'jpg');
            // Hide the Save and Cancel buttons after saving
            saveButton.hide();
            cancelButton.hide();
            //start displaying again after clicking button
            capturing = true;
            capturedImage = null;
        }

        function cancelSave() {
            // Hide the Save and Cancel buttons without saving
            saveButton.hide();
            cancelButton.hide();
            //start displaying again after clicking button
            capturing = true;
            capturedImage = null;
        }

        function applyStarsFilter() {
            applyFilter ='stars'; // Set applyFilter to true to apply the "stars" filter
        }

        function applyMutsFilter() {
            applyFilter = 'hat'; // Set applymuts to true to apply the "stars" filter
        }

        function applyNoFilter() {
            applyFilter = 'none'; // Set applyFilter to false to show the camera feed without a filter
        }

        function applyMustacheFilter(){
            applyFilter = "mustache";
        }

        function gotPoses(poses){
            image(video, 0,0); //draw the image being captured on webcam onto the canvas at the position (0, 0) of the canvas
            
            console.log(poses);
            if(poses.length > 0){
                pose = poses[0].pose; 
                //first pose array in global variable -> has 2 properties: pose & skeleton = we only ask de pose, not skeleton
                skeleton = poses[0].skeleton;
                //first pose array in global variable -> has 2 properties: pose & skeleton = we only ask de skeleton, not pose
                skeleton = poses[0].skeleton;
            }
        }

        function modelLoaded(){
            console.log("ready");
        }

        function draw() {
        //image(video, 0, 0); 
            if (capturedImage == null) { //show self on screen
                image(video, 0,0);
                if(pose){ //filters
                    //hashtag
                    textSize(20);
                    textAlign(RIGHT, BOTTOM);
                    fill(255);
                    text("We are XD", width - 10, height - 10);
                    //variables
                    let noseX = pose.nose.x;
                    let noseY = pose.nose.y;

                    let eyeR = pose.rightEye;
                    let eyeL = pose.leftEye;
                    let d = dist(eyeR.x, eyeR.y, eyeL.x, eyeL.y);

                    let hatWidth = d * 2.5; // Adjust this value to scale the width of the hat
                    let hatHeight = hatWidth * (hatImage.height / hatImage.width);

                    // Calculate the position to place the hat on the person's head
                    let hatX = noseX - hatWidth / 2;
                    let hatY = noseY - hatHeight * 1.5;

                    let musWidth = d * 1.5;
                    let musHeight = musWidth * (snorImage.height / snorImage.width);

                    // Calculate the position to place the mustache
                    let musX = noseX - musWidth / 2;
                    let musY = noseY - musHeight * 0.1;

                    switch (applyFilter) {
                        case 'stars':
                        // Draw stars on the eyes
                            fill(215, 247, 129);
                            noStroke();
                            drawStar(eyeL.x, eyeL.y, d / 3);
                            drawStar(eyeR.x, eyeR.y, d / 3);
                        break;

                        case 'none':
                        // Show nothing but text
                            image(video, 0, 0);
                            textSize(20);
                            textAlign(RIGHT, BOTTOM);
                            fill(255);
                            text("We are XD", width - 10, height - 10);
                        break;

                        case 'hat':
                            //show image of hat on head
                            image(hatImage, hatX, hatY, hatWidth, hatHeight);
                        break;

                        case 'mustache':
                            //show mustache under nose
                            image(snorImage, musX, musY, musWidth, musHeight);
                        break;
                    } 
                }else {
                    image(video, 0, 0);
                    textSize(20);
                    textAlign(RIGHT, BOTTOM);
                    fill(255);
                    text("We are XD", width - 10, height - 10);
                }
            }else {
                //display the captured image
                image(capturedImage, 0, 0);
            }
        }

        function drawStar(x, y, size) {
            // Calculate the angles between points
            let angle = TWO_PI / 5;
            
            // Begin drawing the star
            beginShape();
            
            for (let a = -HALF_PI; a < TWO_PI - HALF_PI; a += angle) {
                let sx = x + cos(a) * size;
                let sy = y + sin(a) * size;
                vertex(sx, sy);
                
                let px = x + cos(a + angle / 2) * (size / 2);
                let py = y + sin(a + angle / 2) * (size / 2);
                vertex(px, py);
            }
            endShape(CLOSE);
        }

    </script>
</html>